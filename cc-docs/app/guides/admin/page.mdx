# Administrator Guide

This guide provides comprehensive instructions for administrators managing Control Core deployments.

## Overview

Control Core administrators are responsible for:

- **System Configuration**: Setting up and maintaining the Control Core platform
- **User Management**: Managing user accounts, roles, and permissions
- **Policy Administration**: Creating, managing, and deploying access control policies
- **Security Management**: Ensuring system security and compliance
- **Monitoring**: Monitoring system performance and security events
- **Integration Management**: Configuring external system integrations

## System Administration

### Dashboard Overview

The Control Core admin dashboard provides a comprehensive view of system status:

- **System Health**: Service status, resource usage, and performance metrics
- **User Activity**: Active users, login history, and session management
- **Policy Status**: Policy deployments, validation status, and performance
- **Security Events**: Audit logs, security alerts, and compliance status
- **Integration Status**: External service connections and health

### System Configuration

#### Global Settings

1. **Navigate to Settings → System**
2. **Configure System Parameters**:
   - **Session Timeout**: Default 8 hours
   - **Password Policy**: Minimum complexity requirements
   - **Rate Limiting**: API request limits
   - **Log Retention**: Audit log retention period

#### Database Management

1. **Database Configuration**
   ```sql
   -- Check database status
   SELECT * FROM pg_stat_activity WHERE datname = 'control_core_db';
   
   -- Monitor database size
   SELECT pg_size_pretty(pg_database_size('control_core_db'));
   
   -- Check table sizes
   SELECT schemaname,tablename,pg_size_pretty(size) as size
   FROM (
     SELECT schemaname,tablename,pg_relation_size(schemaname||'.'||tablename) as size
     FROM pg_tables WHERE schemaname = 'public'
   ) t ORDER BY size DESC;
   ```

2. **Backup Configuration**
   ```bash
   # Create database backup
   pg_dump -h localhost -U postgres control_core_db > backup_$(date +%Y%m%d).sql
   
   # Restore from backup
   psql -h localhost -U postgres control_core_db < backup_20250125.sql
   ```

#### Redis Management

1. **Redis Monitoring**
   ```bash
   # Check Redis status
   redis-cli ping
   
   # Monitor Redis memory usage
   redis-cli info memory
   
   # Check connected clients
   redis-cli client list
   ```

2. **Cache Management**
   ```bash
   # Clear all cache
   redis-cli flushall
   
   # Clear specific cache pattern
   redis-cli --scan --pattern "policy:*" | xargs redis-cli del
   ```

## Environment Management

Control Core provides dual-environment architecture with complete isolation between Sandbox and Production environments.

### Understanding Environments

#### Sandbox Environment

The **Sandbox** environment is where you:
- Create and test all new policies before deploying to production
- Experiment with policy changes safely without affecting live systems
- Validate policies with test users and simulated scenarios
- Run development and QA workflows

All policies must start in Sandbox. Only validated Sandbox policies can be promoted to Production.

#### Production Environment

The **Production** environment is where:
- Validated, tested policies are enforced on live systems
- Real users and production applications are protected
- Policies have been through complete testing and approval processes
- Changes are strictly controlled and audited

### Environment Selector

The environment selector in the top header controls which environment you're viewing and managing:

1. **Switching Environments**
   - Click the environment badge (Sandbox/Production) in the top header
   - Select the environment you want to work in
   - All pages automatically update to show the selected environment's data

2. **Environment Indicators**
   - Each page displays an environment badge showing the current environment
   - Sandbox is indicated with a yellow/blue badge
   - Production is indicated with a red/orange badge

### Environment-Specific Settings

Many system settings are configured separately for each environment to provide complete isolation.

#### Data Sources

Data sources (Policy Information Points) are environment-specific:

1. **Configuring Data Sources**
   - Navigate to **Settings → Data Sources**
   - The current environment is shown in the page header
   - Each data source is associated with either Sandbox or Production
   - Switch environments to manage data sources for that environment

2. **Best Practices**
   - Use test/development endpoints for Sandbox data sources
   - Use production endpoints for Production data sources
   - Credentials may differ between environments for security
   - Test data source connections in Sandbox before creating Production versions

3. **Managing Connections**
   - Create separate data source connections for each environment
   - Configure different endpoints, databases, or API URLs per environment
   - Monitor connection health separately for each environment

#### Notifications and Alerts

Alert configurations are environment-specific to prevent alert fatigue and ensure relevant notifications:

1. **Alert Rules**
   - Navigate to **Settings → Notifications**
   - Configure different alert rules for Sandbox and Production
   - Sandbox alerts typically go to development teams
   - Production alerts go to operations and on-call teams

2. **Notification Channels**
   - Email recipients can differ per environment
   - Slack channels are environment-specific (e.g., #alerts-sandbox vs #alerts-prod)
   - Webhook URLs can point to different systems per environment
   - ServiceNow instances can be different (dev vs production ITSM)

3. **Shared Credentials**
   - Authentication tokens and API keys are shared across environments
   - Only channel endpoints and recipients differ
   - Configure credentials once in the **Credentials** section
   - Simplifies management while maintaining environment separation

#### Protected Resources

Resources are managed per environment:

1. **Resource Configuration**
   - Navigate to **Settings → Protected Resources**
   - View and manage resources for the current environment
   - Each environment has its own set of protected resources
   - Resources typically have different URLs per environment

2. **Environment Isolation**
   - Sandbox resources point to development/staging systems
   - Production resources point to live systems
   - Bouncers are deployed separately for each environment
   - Each Bouncer protects resources in its assigned environment

#### Policy Repository

The policy repository uses a shared GitHub repository with environment-specific folders:

1. **Repository Structure**
   ```
   policies/
   ├── sandbox/
   │   ├── enabled/
   │   └── disabled/
   └── production/
       ├── enabled/
       └── disabled/
   ```

2. **Configuration**
   - Navigate to **Settings → Controls Repository**
   - Configure GitHub repository connection once
   - Policies are automatically organized by environment
   - Separate folders ensure complete policy isolation

3. **Sync Behavior**
   - Changes sync to the appropriate environment folder
   - Sandbox policies deploy from `policies/sandbox/enabled/`
   - Production policies deploy from `policies/production/enabled/`
   - Disabled policies are moved to respective `disabled/` folders

### Bouncer Configuration

Bouncers (Policy Enforcement Points) are environment-aware:

1. **Per-Environment Deployment**
   - Each protected resource has separate Bouncers for Sandbox and Production
   - Bouncers automatically receive policies for their environment
   - Environment is set during Bouncer deployment

2. **Performance Tuning**
   - Navigate to **Settings → Bouncers**, select a Bouncer
   - View and adjust OPAL (policy distribution) settings
   - Configure cache settings:
     - **Cache TTL**: How long to cache policy evaluations
     - **Cache Size**: Maximum cache size
   - Configure rate limits:
     - **Requests Per Second**: Maximum policy evaluation rate
     - **Burst Size**: Maximum burst capacity

3. **Auto-Configuration**
   - Bouncers are auto-configured based on their environment
   - Settings can be customized per Bouncer if needed
   - Default settings are optimized for typical usage

### Environment Promotion

Moving policies from Sandbox to Production:

1. **Promotion Process**
   - Create and test policy in Sandbox environment
   - Run comprehensive test suite in Sandbox
   - Validate policy behaves as expected
   - Click **Promote to Production** from the policy detail page
   - Review and confirm promotion

2. **Safety Controls**
   - Policies must pass all tests before promotion
   - Promotion creates a new policy in Production environment
   - Original Sandbox policy remains unchanged
   - Production policies cannot be edited directly
   - Changes must be made in Sandbox, then re-promoted

3. **Audit Trail**
   - All promotions are logged
   - Track who promoted what policy and when
   - View promotion history in audit logs

### Environment Best Practices

1. **Development Workflow**
   - Always create policies in Sandbox first
   - Test thoroughly with various scenarios
   - Use test users and data in Sandbox
   - Only promote stable, validated policies to Production

2. **Data Isolation**
   - Use separate data sources for each environment
   - Connect to test/dev systems in Sandbox
   - Connect to production systems in Production
   - Never mix development and production data

3. **Team Structure**
   - Developers work primarily in Sandbox
   - Operations team manages Production
   - Restricted access to Production environment
   - Use role-based access control

4. **Monitoring**
   - Monitor both environments separately
   - Set appropriate alert thresholds per environment
   - Sandbox can be more lenient with alerts
   - Production should have strict monitoring

## User Management

### User Accounts

#### Creating Users

1. **Navigate to Users → Add User**
2. **Fill in User Information**:
   - **Email**: User's email address
   - **Name**: Full name
   - **Role**: Admin, Manager, Developer, or Viewer
   - **Department**: Optional department assignment

3. **Set Initial Password**
   - Generate secure password
   - Send password reset email to user

#### User Roles and Permissions

| Role | Permissions |
|------|-------------|
| **Admin** | Full system access, user management, system configuration |
| **Manager** | Policy management, user management (non-admin), audit access |
| **Developer** | Policy creation/editing, resource management, testing |
| **Viewer** | Read-only access to policies and reports |

#### Managing User Sessions

1. **View Active Sessions**
   - Navigate to Users → Active Sessions
   - Monitor user activity and session duration

2. **Terminate Sessions**
   - Select user session
   - Click "Terminate Session"
   - User will be logged out immediately

### Authentication Configuration

#### Auth0 Integration

1. **Configure Auth0 Application**
   ```javascript
   // Auth0 configuration
   {
     "domain": "your-domain.auth0.com",
     "clientId": "your-client-id",
     "clientSecret": "your-client-secret",
     "audience": "https://api.controlcore.io",
     "scope": "openid profile email"
   }
   ```

2. **Set up SAML SSO**
   - Configure SAML identity provider
   - Upload SAML certificate
   - Map SAML attributes to user fields

#### Password Policy

1. **Configure Password Requirements**
   - Minimum length: 12 characters
   - Require uppercase, lowercase, numbers, symbols
   - Password history: 5 previous passwords
   - Expiration: 90 days

2. **Multi-Factor Authentication**
   - Enable MFA for admin accounts
   - Configure TOTP (Time-based One-Time Password)
   - Set up backup codes

## Policy Administration

### Policy Management

#### Creating Policies

1. **Navigate to Policies → Create Policy**
2. **Policy Configuration**:
   - **Name**: Descriptive policy name
   - **Description**: Policy purpose and scope
   - **Category**: Access control, data protection, compliance
   - **Environment**: Sandbox, staging, production

3. **Policy Content**:
   ```rego
   package access_control
   
   import rego.v1
   
   # Allow access for admin users
   allow if {
       input.user.roles[_] == "admin"
   }
   
   # Allow access for users with specific permission
   allow if {
       input.user.permissions[_] == input.required_permission
   }
   ```

#### Policy Validation and Testing

1. **Syntax Validation**
   - Real-time syntax checking
   - Error highlighting and suggestions
   - Policy structure validation

2. **Test Cases**
   ```json
   [
     {
       "name": "Admin Access",
       "input": {
         "user": {"roles": ["admin"]},
         "resource": {"type": "api"}
       },
       "expected": true
     },
     {
       "name": "User Access",
       "input": {
         "user": {"roles": ["user"]},
         "resource": {"type": "api"}
       },
       "expected": false
     }
   ]
   ```

#### Policy Deployment

1. **Deployment Process**
   - Validate policy syntax and logic
   - Run comprehensive test suite
   - Deploy to sandbox environment
   - Monitor for issues
   - Promote to production

2. **Rollback Procedures**
   - Keep previous policy versions
   - Quick rollback capability
   - Automated rollback on errors

### Resource Management

#### Protected Resources

1. **Define Resources**
   - **API Endpoints**: REST API routes
   - **Data Objects**: Database tables and records
   - **Files**: Documents and media files
   - **Services**: External service integrations

2. **Resource Attributes**
   ```json
   {
     "id": "api-users",
     "type": "api",
     "path": "/api/v1/users",
     "method": "GET",
     "sensitivity": "confidential",
     "owner": "hr-department"
   }
   ```

#### Access Control Configuration

1. **Role-Based Access Control (RBAC)**
   - Define roles and permissions
   - Assign users to roles
   - Map roles to resource access

2. **Attribute-Based Access Control (ABAC)**
   - Define attributes for users and resources
   - Create attribute-based policies
   - Dynamic access decisions

## Security Management

### Security Monitoring

#### Audit Logging

1. **Enable Comprehensive Logging**
   - User authentication events
   - Policy evaluation decisions
   - Administrative actions
   - System configuration changes

2. **Log Analysis**
   ```bash
   # Search for failed login attempts
   grep "authentication failed" /var/log/controlcore/audit.log
   
   # Monitor policy evaluation performance
   grep "policy_evaluation" /var/log/controlcore/audit.log | grep "slow"
   
   # Check administrative actions
   grep "admin_action" /var/log/controlcore/audit.log
   ```

#### Security Alerts

1. **Configure Alert Rules**
   - Failed login attempts (5+ in 10 minutes)
   - Unusual API usage patterns
   - Policy evaluation errors
   - System resource thresholds

2. **Alert Response**
   - Email notifications to administrators
   - Slack/Teams integration
   - Automated incident response

### Compliance Management

#### GDPR Compliance

1. **Data Protection Measures**
   - Data encryption at rest and in transit
   - Access logging and monitoring
   - Data retention policies
   - User consent management

2. **Right to be Forgotten**
   - User data deletion procedures
   - Audit trail maintenance
   - Data anonymization options

#### SOC 2 Compliance

1. **Security Controls**
   - Access controls and authentication
   - Data encryption and protection
   - Monitoring and logging
   - Incident response procedures

2. **Audit Trail**
   - Comprehensive activity logging
   - Tamper-proof log storage
   - Regular audit reviews

## Integration Management

### External System Integration

#### API Integrations

1. **REST API Configuration**
   ```yaml
   integrations:
     - name: "hr-system"
       type: "rest_api"
       base_url: "https://hr.company.com/api"
       authentication:
         type: "bearer_token"
         token: "your-api-token"
       endpoints:
         - path: "/users"
           method: "GET"
           description: "Get user information"
   ```

2. **Webhook Configuration**
   ```yaml
   webhooks:
     - name: "user-updates"
       url: "https://controlcore.company.com/webhooks/user-update"
       events: ["user.created", "user.updated", "user.deleted"]
       authentication:
         type: "hmac"
         secret: "webhook-secret"
   ```

#### Database Integrations

1. **External Database Connection**
   ```python
   # Database integration configuration
   DATABASE_CONNECTIONS = {
       "hr_db": {
           "type": "postgresql",
           "host": "hr-db.company.com",
           "database": "hr_system",
           "username": "controlcore_user",
           "password": "secure_password"
       }
   }
   ```

2. **Data Synchronization**
   - Configure sync schedules
   - Set up data mapping
   - Monitor sync status

### AI Service Integration

#### AI Provider Configuration

1. **OpenAI Integration**
   ```yaml
   ai_services:
     openai:
       api_key: "sk-..."
       model: "gpt-4"
       max_tokens: 4096
       temperature: 0.7
   ```

2. **Anthropic Integration**
   ```yaml
   ai_services:
     anthropic:
       api_key: "sk-ant-..."
       model: "claude-3-sonnet"
       max_tokens: 4096
   ```

#### Content Filtering

1. **Configure Content Policies**
   - Define sensitive content categories
   - Set filtering rules
   - Configure response actions

2. **Monitor AI Usage**
   - Track API calls and costs
   - Monitor response times
   - Set usage limits and alerts

## Monitoring and Maintenance

### Performance Monitoring

#### System Metrics

1. **Resource Monitoring**
   - CPU and memory usage
   - Database performance
   - Network throughput
   - Disk I/O performance

2. **Application Metrics**
   - API response times
   - Policy evaluation performance
   - User session duration
   - Error rates

#### Alerting Configuration

1. **Set up Monitoring Alerts**
   ```yaml
   alerts:
     - name: "high_cpu_usage"
       condition: "cpu_usage > 80%"
       duration: "5 minutes"
       actions: ["email", "slack"]
     
     - name: "database_slow_queries"
       condition: "slow_queries > 10"
       duration: "2 minutes"
       actions: ["email"]
   ```

2. **Incident Response**
   - Define escalation procedures
   - Set up on-call rotations
   - Create incident response playbooks

### Backup and Recovery

#### Backup Strategy

1. **Database Backups**
   ```bash
   # Daily automated backup
   pg_dump -h localhost -U postgres control_core_db | gzip > backup_$(date +%Y%m%d).sql.gz
   
   # Weekly full backup
   pg_basebackup -h localhost -U postgres -D /backups/weekly/$(date +%Y%m%d)
   ```

2. **Configuration Backups**
   ```bash
   # Backup configuration files
   tar -czf config_backup_$(date +%Y%m%d).tar.gz /etc/controlcore/
   
   # Backup policy files
   cp -r /var/lib/controlcore/policies /backups/policies_$(date +%Y%m%d)
   ```

#### Disaster Recovery

1. **Recovery Procedures**
   - Document recovery steps
   - Test recovery procedures
   - Maintain recovery contacts

2. **Business Continuity**
   - Identify critical functions
   - Define recovery time objectives
   - Plan for service continuity

## Support and Documentation

### Getting Help

- **Documentation**: [docs.controlcore.io](https://docs.controlcore.io)
- **Community Forum**: [community.controlcore.io](https://community.controlcore.io)
- **Support Email**: support@controlcore.io
- **Emergency Support**: emergency@controlcore.io

### Contact Information

- **General Inquiries**: info@controlcore.io
- **Technical Support**: support@controlcore.io
- **Security Issues**: security@controlcore.io
